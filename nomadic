#!/bin/bash

if [ "$1" == "uninstall" ]; then
    echo "uninstalling..."
    shift
    cd ~/
    rm -fR nomadic
    sudo rm -f /bin/nomadic
    rm -fR cabage
    rm -fR bin
    rm -fR dwm
    rm -f .screenrc
    rm -f .irc.el
    redis-cli flushdb > /dev/null
    echo "uninstalled."
    echo "Continuing in 10 seconds.  Press Ctrl-c to stop..."
    sleep 10
fi

if [ "$1" == 'install' ]; then
    echo "installing..."
    shift
    if [ ! -d ~/nomadic ]; then
	cd ~
	git clone --quiet https://github.com/xorgnak/nomadic
    else
	cd ~/nomadic && work pull
    fi
    sudo cp -vv ~/nomadic/nomadic /bin/nomadic
    echo "installed."
fi

echo "##### OK"

echo ""
printf "[cabage] "
if [ ! -d ~/cabage ]; then
    printf "getting... "
    cd ~;
    git clone --quiet https://github.com/xorgnak/cabage && cd cabage && ./now;
    sudo cp work /bin/work
    printf "got! "
fi
printf "READY."
echo ""

printf "[gui] "
if [ "`redis-cli hget nomadic gui`" == 'true' ]; then
    if [ ! -d ~/dwm ]; then
	printf "getting... "
	cd ~;
	git clone --quiet https://github.com/xorgnak/dwm && cd dwm && ./now;
	printf "got! "
    fi
    printf "READY."
else
    printf "NONE."
fi

echo ""
printf "[rtc] "
if [ "`redis-cli hget nomadic peer`" == 'true'  ]; then
    if [ `which peerjs` == '' ]; then
	printf "getting... "
	sudo apt-get install npm > /dev/null
	sudo npm install peer -g
	printf "got! "
    fi
    printf "READY."
else
    printf "NONE."
fi


echo ""
printf "[arduino] "
if [ "`redis-cli hget nomadic iot`" == 'true'  ]; then
    if [ ! -d  ~/.arduino15 ]; then
	printf "getting... "
	cd ~;
	curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh -;
	cd bin;
	./arduino-cli config init;
	editor ~/.arduino15/arduino-cli.yaml
	./arduino-cli core update-index;
	printf "got! "
    fi
    printf "READY."
else
    printf "NONE."
fi
echo ""
printf "[radio] "
if [ "`redis-cli hget nomadic radio`" == 'true'  ]; then
    if [ ! -d ~/radio ]; then
	printf "getting... "
	sudo apt-get install -y rtl-sdr fldigi wsjtx gqrx-srd > /dev/null;
	mkdir ~/radio
	printf "got! "
    fi
    printf "READY."
else
    printf "NONE."  
fi

echo ""
printf "[media] "
if [ "`redis-cli hget nomadic gui`" == 'true' ]; then
    if [ ! -d ~/video ]; then
	printf "getting... "
	cd ~;
	sudo apt-get install -y obs vlc > /dev/null
	mkdir ~/video
	printf "got! "
    fi
    printf "READY."
else
    printf "NONE."
fi

echo ""
echo "##### READY TO BEGIN"

if [ "$1" == "configure" ]; then
    sudo update-alternatives --config editor
    sudo update-alternatives --config x-terminal-emulator
    sudo update-alternatives --config x-www-browser
elif [ "$1" == '--help' ] || [ "$1" == "help" ] || [ "$1" == "-h" ]; then
    echo "usage: ./$0 [configure|wipe|install]"
    echo "- configure: set default applications."
    echo "- uninstall: clean nomadic from the system."
    echo "- install: install nomadic on the system."
    echo "start nomadic."
else
    cd ~/cabage && ./now $*;
    exit 0
fi
echo "##### GOODBYE"

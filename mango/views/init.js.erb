window.onload = function(){                                                                                                                                                                                                                                                                                                 
    (function(){                                                                                                                                                                                                                                                                                                            
        var show = function(el){                                                                                                                                                                                                                                                                                            
            return function(msg){ el.innerHTML = msg; }                                                                                                                                                                                                                                                                     
        }(document.getElementById('message'));                                                                                                                                                                                                                                                                              
        function update(m) {                                                                                                                                                                                                                                                                                                
            j = JSON.parse(m);                                                                                                                                                                                                                                                                                              
            console.log("update: ", j);                                                                                                                                                                                                                                                                                     
            $('#message').html(j.message);                                                                                                                                                                                                                                                                                  
            $('#content').html(j.content);                                                                                                                                                                                                                                                                                  
                <% CONF['webconfig']['stats'].each_pair do |k,v| %>                                                                                                                                                                                                                                                                      
                $('#<%= k %>').text(j.state.<%= k %>);                                                                                                                                                                                                                                                                      
                <% end %>                                                                                                                                                                                                                                                                                                   
        }                                                                                                                                                                                                                                                                                                                   
        var ws       = new WebSocket('ws://' + window.location.host + window.location.pathname);                                                                                                                                                                                                                            
        ws.onopen    = function()  { show("<h3>connecting to central command...</h3>"); };                                                                                                                                                                                                                                      
        ws.onclose   = function()  { show('<h3>ERR 0x0101dead</h3><p>Your zapper aquired too many bugs.  Let your rider go clean up the mess and then you can get back in the fight!</p><h3>Great Job!</h3>'); } ;                                                                                                        
        ws.onmessage = function(m) { update(m.data); };                                                                                                                                                                                                                                                                     
       
        var sender = function(f){                                                                                                                                                                                                                                                                                           
//            var input     = document.getElementById('input');                                                                                                                                                                                                                                                               
//            input.onclick = function(){ input.value = "" };                                                                                                                                                                                                                                                                 
            f.onsubmit    = function(){                                                                                                                                                                                                                                                                                     
                ws.send($('#input').val());                                                                                                                                                                                 
                input.value = '';                                                                                                                                                                                                                                                                                           
                return false;                                                                                                                                                                                                                                                                                               
            }                                                                                                                                                                                                                                                                                                               
        }(document.getElementById('foot'));                                                                                                                                                                                                                                                                                 
    })();                                                                                                                                                                                                                                                                                                                   
}                                                                                                                                                                                                                                                                                                                           

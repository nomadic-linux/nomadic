window.onload = function(){                                                                                                                                                                                                                                                                                                 
    (function(){                                                                                                                                                                                                                                                                                                            
        var show = function(el){                                                                                                                                                                                                                                                                                            
            return function(msg){ el.innerHTML = msg; }                                                                                                                                                                                                                                                                     
        }(document.getElementById('message'));                                                                                                                                                                                                                                                                              
        function update(m) {                                                                                                                                                                                                     if (m != null) {                                                                                           
            j = JSON.parse(m);                                                                                                                                                                                                                                                                                              
            console.log("update: ", j);                                                                                                                                                                                                                                                                                     
            $('#message').html(j.message);                                                                                                                                                                                                                                                                                  
            $('#content').html(j.content);                                                                                                                                                                                                                                                                                  
                <% CONF['webconfig']['stats'].each_pair do |k,v| %>                                                                                                                                                                                                                                                                      
                $('#<%= k %>').val(j.state.<%= k %>);                                                                                                                                                                                                                                                                      
                <% end %>
                }
        }                                                                                                                                                                                                                                                                                                                   
        var ws       = new WebSocket('ws://' + window.location.host + window.location.pathname);                                                                                                                                                                                                                            
        ws.onopen    = function()  { show("<h1>Enter your phone number below to continue...</h1>"); };
        ws.onclose   = function()  { show('<h3>ERR 0x0101dead</h3><p>Your zapper aquired too many bugs.  Let your rider go clean up the mess and then you can get back in the fight!</p><h3>Great Job!</h3>'); } ;                                                                                                        
        ws.onmessage = function(m) { update(m.data); };
        var sender = function(f){
            f.onsubmit    = function(ev){
            		  ev.preventDefault();
                ws.send($('#input').val());	                                                                                                                                                                              
                input.value = '';                                                                                                                                                                                                                                                                            
                return false;                                                                                                                                                                                                                                                                                               
            }                                                                                                                                                                                                                                                                                                               
        }(document.getElementById('form'));                                                                                                                                                                                                                                                                                 
    })();                                                                                                                                                                                                                                                                                                                   
}                                                                                                                                                                                                                                                                                                                           
